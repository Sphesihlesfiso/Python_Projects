<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link href="css/style.css" rel="stylesheet" />
  </head>

  <body>
    <%- include("partials/header") %>

    <div class="cart-wrapper">
      <div class="container">
        <div class="row g-4">
          <!-- Cart Items Section -->
          <div class="col-lg-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0">Shopping Cart</h4>
              <span class="text-muted"><%= bagsIncart.length %></span>
            </div>

            <!-- Product Cards -->
            <div class="d-flex flex-column gap-3">
              <% bagsIncart.forEach(bag => { %>
              <div class="product-card p-3 shadow-sm">
                <div class="row align-items-center">
                  <div class="col-md-2">
                    <img
                      src="/images/<%= bag.image %>"
                      alt="<%= bag.name %>"
                      class="product-image"
                    />
                  </div>
                  <div class="col-md-4">
                    <p class="text-muted mb-0"><%= bag.name %></p>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex align-items-center gap-2">
                      <% if (bag.available_bags>0) { %>
                      <button
                        class="quantity-btn"
                        onclick="updateQuantity(<%= bag.bag_id %>, -1,<%= bag.available_bags %>)"
                      >
                        -
                      </button>
                      <input
                        type="number"
                        id="quantity-input-<%= bag.bag_id %>"
                        class="quantity-input"
                        value="1"
                        min="1"
                        max="<%= bag.available_bags %>"
                      />
                      <button
                        class="quantity-btn"
                        onclick="updateQuantity(<%= bag.bag_id %>, 1,<%= bag.available_bags %>)"
                      >
                        +
                      </button>
                      <% } else { %>
                      <p>Out of stock</p>
                      <% } %>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <span
                      id="bag-price-<%= bag.bag_id %>"
                      class="fw-bold"
                      style="display: none"
                      >R<%= bag.price %></span
                    >
                    <span id="total-price-<%= bag.bag_id %>" class="fw-bold"
                      >R<%= bag.price %></span
                    >
                  </div>
                  <div class="col-md-1">
                    <i
                      id="<%= bag.bag_id %>"
                      class="bi bi-trash remove-btn"
                      onclick="deleteItem(<%= bagsIncart %>,<%= bag.bag_id %>)"
                    ></i>
                  </div>
                </div>
              </div>
              <% }) %>
            </div>
          </div>

          <!-- Order Summary Section -->
          <div class="col-lg-12 mt-2">
            <div class="summary-card p-4 shadow-sm">
              <h5 class="mb-4">Order Summary</h5>

              <div class="d-flex justify-content-between mb-3">
                <span class="text-muted">Subtotal</span>
                <span id="summary-subtotal">R0.00</span>
              </div>
              <div class="d-flex justify-content-between mb-3">
                <span class="text-muted">Delivery</span>
                <span id="summary-Delivery">R500.00</span>
              </div>
              <hr />
              <div class="d-flex justify-content-between mb-4">
                <span class="fw-bold">Total</span>
                <span id="summary-total" class="fw-bold">R0.00</span>
              </div>

              <a href="/checkout"
                ><button class="btn btn-outline-dark w-100 mb-3">
                  Proceed to Checkout
                </button></a
              >

              <div class="d-flex justify-content-center mx-2 my-2 gap-2">
                <i class="bi bi-shield-check text-success"></i>
                <small class="text-muted">Secure checkout</small>
              </div>
            </div>
          </div>
          <!-- End Order Summary -->
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function updateQuantity(id, change, cap) {
        const quantityInput = document.getElementById(`quantity-input-${id}`);

        const trashButton = document.getElementById(`trash-${id}`);
        let quantity = parseInt(quantityInput.value);
        const maxQuantity = cap;
        quantity = Math.max(1, Math.min(maxQuantity, quantity + change));
        quantityInput.value = quantity;

        const priceText = document.getElementById(
          `bag-price-${id}`
        ).textContent;
        const unitPrice = parseFloat(priceText.replace("R", ""));

        const total = unitPrice * quantity;
        document.getElementById(
          `total-price-${id}`
        ).textContent = `R${total.toFixed(2)}`;

        // Recalculate order summary after updating this product
        updateSummary();
      }

      function updateSummary() {
        let subtotal = 0;

        // Loop through all product total elements
        document.querySelectorAll(".product-card").forEach((card) => {
          const quantityInput = card.querySelector(".quantity-input");
          const totalEl = card.querySelector("[id^='total-price-']");

          if (quantityInput && totalEl) {
            subtotal += parseFloat(totalEl.textContent.replace("R", ""));
          }
        });

        // Example: fixed discount of 5% if subtotal > 100

        let Delivery = subtotal > 0 ? 500 : 0; // free if empty cart?

        let total = subtotal + Delivery;

        document.getElementById(
          "summary-subtotal"
        ).textContent = `R${subtotal.toFixed(2)}`;
        document.getElementById(
          "summary-Delivery"
        ).textContent = `R${Delivery.toFixed(2)}`;
        document.getElementById(
          "summary-total"
        ).textContent = `R${total.toFixed(2)}`;
      }

      // Run once on page load
      function deleteItem(bagsIncart, id) {
        const pricText = (document.getElementById(
          `bag-price-${id}`
        ).textContent = "D");
        bagsIncart.filter(bag.bag_id !== id);
      }
      window.onload = updateSummary;
    </script>

    <script src="/js/main.js"></script>
  </body>
</html>
